server {
    server_name "~^www\.(.*)$" ;
    return 301 $scheme://$1$request_uri ;
}

server {
  listen 80 default_server;
  listen [::]:80 default_server;

  root /var/www/html;
  index index.php index.html;
  autoindex off;

  real_ip_header X-Forwarded-For;
  real_ip_recursive on;

  client_max_body_size 64m;

  location / {
    try_files $uri $uri/ /index.php?$args;
  }

  location /wp-admin/ {
    try_files $uri $uri/ /index.php?$args;
  }

  location ~ /\.(?!well-known) {
    deny all;
    access_log off;
    log_not_found off;
  }

  location = /wp-config.php { deny all; }
  location ~* /(readme|license)\.txt$ { deny all; }

  # OPTIONAL: disable XML-RPC entirely (Jetpack/mobile will break if enabled)
  location = /xmlrpc.php { deny all; }

  location ~* ^/(wp-content|wp-includes|uploads|files)/.*\.(?:php[0-9]?|phtml|phar)$ {
    deny all;
  }

  location ~* \.(?:jpg|jpeg|png|gif|svg|ico|css|js|woff2?|ttf|eot|otf|webp|avif)$ {
    expires 7d;
    add_header Cache-Control "public, immutable";
    access_log off;
    try_files $uri =404;
  }

  location ~ \.php$ {
    try_files $uri =404;
    include fastcgi_params;
    fastcgi_index index.php;
    fastcgi_pass wordpress:9000;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;
    fastcgi_read_timeout 180;
  }

  location ~* /wp-admin/admin-ajax\.php$ {
    include fastcgi_params;
    fastcgi_pass wordpress:9000;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  }

  location = /favicon.ico  { access_log off; log_not_found off; }
  location = /robots.txt   { access_log off; log_not_found off; }
}
